name: Sync

on:
  schedule:
    - cron: '0 0 * * 0' # 每周日 00:00 运行，后续可更改为 webhook 触发
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-feishu
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Download dependencies
        run: go mod download

      - name: Ensure output directory
        run: mkdir -p public/bookcase

      - name: Run sync (go run ./cmd)
        env:
          BLOGAPI_FEISHU_APP_ID: ${{ secrets.BLOGAPI_FEISHU_APP_ID }}
          BLOGAPI_FEISHU_APP_SECRET: ${{ secrets.BLOGAPI_FEISHU_APP_SECRET }}
          BLOGAPI_FEISHU_TABLE_ID: ${{ secrets.BLOGAPI_FEISHU_TABLE_ID }}
          BLOGAPI_FEISHU_APP_TOKEN: ${{ secrets.BLOGAPI_FEISHU_APP_TOKEN }}
          BLOGAPI_FEISHU_DOWNLOAD_DIR: public/bookcase
        run: go run ./cmd

      - name: Update deployment timestamp
        run: |
          echo "Last sync: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > LAST_SYNC.md
          echo "Workflow run: ${{ github.run_number }}" >> LAST_SYNC.md
          echo "Trigger: ${{ github.event_name }}" >> LAST_SYNC.md

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'Automated: Sync data from Feishu'
          file_pattern: 'public/bookcase/**/* LAST_SYNC.md'
